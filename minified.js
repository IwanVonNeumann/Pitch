var Config={target:""};var ResourceLoader={pgsounds:null,images:null,numloaded:0,imgloaded:0,addImage:function(a){null==this.images&&(this.images=[]);this.images.push(a)},addSound:function(a){null==this.sounds&&(this.sounds=[]);this.sounds.push(a)},loadAll:function(a,b){this.callback=b;this.loadProgress=a;if(null!=this.images)for(var c=0;c<this.images.length;++c){var d=this.images[c];this.images[c]=new Image;this.images[c].onload=ResourceLoader.resourceLoaded;this.images[c].onerror=this.aborted;this.images[c].onabort=this.errorr;
this.images[c].src=d}if(null!=this.sounds)for(c=0;c<this.sounds.length;++c)d=this.sounds[c],this.sounds[c]=new Audio(d),this.sounds[c].addEventListener("canplaythrough",ResourceLoader.resourceLoaded(),!1)},resourceLoaded:function(){++ResourceLoader.numloaded;var a=(null==ResourceLoader.images?0:ResourceLoader.images.length)+(null==ResourceLoader.sounds?0:ResourceLoader.sounds.length);ResourceLoader.numloaded==a?ResourceLoader.callback():ResourceLoader.loadProgress(Math.floor(100*ResourceLoader.numloaded/
a))},aborted:function(){console.log("resource abortion")},errorr:function(){console.log("resource error")}};var Constants={phi:1.61803398874989,scr_w:480,scr_h:320,key_w0:3,key_h0:12,key_w1:2,key_dw:1,key_h1:9,key_scale:5,keys_h:150,key_state_disabled:0,key_state_active:1,key_state_pressed:2,key_state_active_pressed:3,num_octaves:3,num_tones_in_octave:12,tone_c:0,color_c:4278255615,tone_c_sharp:1,color_c_sharp:4294901888,tone_d:2,color_d:4278255360,tone_e_flat:3,color_e_flat:4286578943,tone_e:4,color_e:4294967040,tone_f:5,color_f:4278223103,tone_f_sharp:6,color_f_sharp:4294901760,tone_g:7,color_g:4278255488,
tone_a_flat:8,color_a_flat:4294902015,tone_a:9,color_a:4286643968,tone_b_flat:10,color_b_flat:4278190335,tone_b:11,color_b:4294934528,num_levels:15,uni:0,min2:1,maj2:2,min3:3,maj3:4,per4:5,aug4:6,per5:7,min6:8,maj6:9,min7:10,maj7:11,per8:12,min9:13,maj9:14,min10:15,maj10:16,init:function(){var a=document.getElementById("canvas");null!==a&&(this.scr_w=a.clientWidth,this.scr_h=a.clientHeight);this.tone_widths=[this.key_w0+this.key_w1,this.key_w0+this.key_w1,this.key_w0+this.key_w1,this.key_w0+this.key_w1,
this.key_w0+this.key_w1+0.5,this.key_w0+this.key_w1+0.5,this.key_w0+this.key_w1];this.white_tones=[this.tone_c,this.tone_d,this.tone_e,this.tone_f,this.tone_g,this.tone_a,this.tone_b];this.tones=[this.tone_f_sharp,this.tone_e_flat,this.tone_a,this.tone_c,this.tone_c_sharp,this.tone_e,this.tone_g,this.tone_b_flat,this.tone_d,this.tone_f,this.tone_b,this.tone_a_flat];this.tone_names="C C# D Eb E F F# G G# A Bb B".split(" ");this.intervals=[this.per8,this.per4,this.per5,this.maj3,this.min3,this.min2,
this.maj2,this.maj6,this.min6,this.min7,this.maj7,this.aug4];this.steps=[this.uni,this.maj2,this.min3,this.per4,this.per5,this.min6,this.min7,this.maj3,this.maj7,this.maj6,this.aug4];this.interval_names="unison;minor 2;major 2;minor 3;major 3;perfect 4;tritone;perfect 5;minor 6;major 6;minor 7;major 7;octave;minor 9;major 9;minor 10;major 10".split(";");this.level_names="Major 1, 3, 5;Minor 1, 3, 5;Major 1, 3, 4, 5;Minor 1, 3, 4, 5;Major 1-5;Minor 1-5;Major Pentatonic;Minor Pentatonic;Major 1-6;Minor 1-6;Blues;Major;Minor;Harmonic Minor;Melodic Minor;Minor, 1 accidental;Minor, 2 accidentals;Minor, 3 accidentals;Minor, 4 accidentals;Chromatic".split(";");
this.steps_by_levels=[[this.uni,this.maj3,this.per5],[this.uni,this.min3,this.per5],[this.uni,this.maj3,this.per4,this.per5],[this.uni,this.min3,this.per4,this.per5],[this.uni,this.maj2,this.maj3,this.per4,this.per5],[this.uni,this.maj2,this.min3,this.per4,this.per5],[this.uni,this.maj2,this.maj3,this.per5,this.maj6],[this.uni,this.min3,this.per5,this.min6,this.min7],[this.uni,this.maj2,this.maj3,this.per4,this.per5,this.maj6],[this.uni,this.maj2,this.min3,this.per4,this.per5,this.min6],[this.uni,
this.min3,this.per4,this.aug4,this.per5,this.min7],[this.uni,this.maj2,this.maj3,this.per4,this.per5,this.maj6,this.maj7],[this.uni,this.maj2,this.min3,this.per4,this.per5,this.min6,this.min7],[this.uni,this.maj2,this.min3,this.per4,this.per5,this.min6,this.maj7],[this.uni,this.maj2,this.min3,this.per4,this.per5,this.maj6,this.maj7],[this.uni,this.maj2,this.min3,this.per4,this.per5,this.maj6,this.min7,this.maj7],[this.uni,this.maj2,this.min3,this.per4,this.per5,this.min6,this.maj6,this.min7,this.maj7],
[this.uni,this.maj2,this.min3,this.per4,this.aug4,this.per5,this.min6,this.maj6,this.min7,this.maj7],[this.uni,this.maj2,this.min3,this.maj3,this.per4,this.aug4,this.per5,this.min6,this.maj6,this.min7,this.maj7],[this.uni,this.min2,this.maj2,this.min3,this.maj3,this.per4,this.aug4,this.per5,this.min6,this.maj6,this.min7,this.maj7]]},phiOrder:function(a){var b=1/this.phi;return 1==a?b:b*this.phiOrder(a-1)},getNumMelodyLevels:function(){return this.steps_by_levels.length},isMajor:function(a){return 0==
a||2==a||4==a||6==a||8==a||11==a},isBlack:function(a){a%=this.num_tones_in_octave;return a==this.tone_c_sharp||a==this.tone_e_flat||a==this.tone_f_sharp||a==this.tone_a_flat||a==this.tone_b_flat},generalToneName:function(a){return this.tone_names[a%12]},toneName:function(a){return this.generalToneName(a)},longToneName:function(a){return this.generalToneName(a)+(Math.floor(a/12)+1).toString()},isWhiteTone:function(a){return-1!=this.white_tones.indexOf(a)},isSharpKey:function(a,b){b||(a=(a+3)%12);return a==
this.tone_c||a==this.tone_g||a==this.tone_d||a==this.tone_a||a==this.tone_e||a==this.tone_b||a==this.tone_f_sharp||a==this.tone_c_sharp},toneNameInKey:function(a,b,c){if(0>a)return"";a%=12;return this.isWhiteTone(a)?this.toneName(a):this.isSharpKey(b,c)?this.toneName(a-1+12)+"#":this.toneName(a+1)+"b"},longToneNameInKey:function(a,b,c){return this.toneNameInKey(a,b,c)+(Math.floor(a/12)+1).toString()}};var KeyStates={disabled:0,active:1,pressed:2,active_pressed:3};var ExcerciseStates={pending:0,waiting:1,waiting0:2,waiting1:3,answered:4,two_mode:5,level_complete:6,game_over:7};var AnimationManager={init:function(){var a="";"web"!=Config.target&&(a="mobile/");ResourceLoader.addImage("img/"+a+"keysgreen.png");ResourceLoader.addImage("img/"+a+"keysgreenpressed.png");ResourceLoader.addImage("img/"+a+"keysdisabled.png");ResourceLoader.addImage("img/"+a+"keysdisabledpressed.png")},CreateKeysGreenAnim:function(){return ResourceLoader.images[0]},CreateKeysGreenPressedAnim:function(){return ResourceLoader.images[1]},CreateKeysDisabledAnim:function(){return ResourceLoader.images[2]},
CreateKeysDisabledPressedAnim:function(){return ResourceLoader.images[3]}};var SoundManager={sounds:Array(12*Constants.num_octaves),canPlayAudio:function(){var a=document.createElement("audio"),b="function"===typeof a.canPlayType&&""!==a.canPlayType("audio/mpeg");return"function"===typeof a.canPlayType&&""!==a.canPlayType("audio/ogg")||b},init:function(){var a=window.parent.g_instrument;void 0==a&&(a="piano");var b=document.createElement("audio");"function"===typeof b.canPlayType&&b.canPlayType("audio/mpeg");var c=".ogg";"function"===typeof b.canPlayType&&""!==b.canPlayType("audio/ogg")||
(c=".mp3");for(b=0;b<this.sounds.length;++b){var d=9>b?"0":"",d=d+(b+1);ResourceLoader.addSound(a+"/"+a+"_silence_"+d+c)}},playSound:function(a,b){void 0==b&&(b=1);var c=ResourceLoader.sounds[a];c.pause();c.volume=b;c.currentTime=0;c.play()}};function Interval(){this.diff=this.tone0=0}function intervalPlaySound(a){SoundManager.playSound(a)}
Interval.prototype={equal:function(a){return this.tone0==a.tone0&&this.diff==a.diff},play:function(){intervalPlaySound(this.tone0);var a=this.tone0+this.diff;setTimeout(function(){intervalPlaySound(a)},1E3)},randomOfTwo:function(a,b){tone_ind=RandomUtil.getMod(2);this.diff=0==tone_ind?a:b;0.5<RandomUtil.getNormalised()&&(this.diff=-this.diff);this.tone0=RandomUtil.getMod(Constants.num_tones_in_octave);var c=RandomUtil.getMod(Constants.num_octaves);for(this.tone0+=c*Constants.num_tones_in_octave;0>
this.tone0+this.diff||this.tone0+this.diff>=Constants.num_tones_in_octave*Constants.num_octaves||this.tone0==IntervalHelperStatic.prev_tone0;)this.tone0=RandomUtil.getMod(Constants.num_tones_in_octave),c=RandomUtil.getMod(Constants.num_octaves),this.tone0+=c*Constants.num_tones_in_octave;IntervalHelperStatic.prev_tone0=this.tone0},randomInterval:function(a){this.diff=0;num_intervals=Math.min(a+2,Constants.intervals.length);interval_ind=RandomUtil.getMod(num_intervals);this.diff=Constants.intervals[interval_ind];
0.5<RandomUtil.getNormalised()&&(this.diff=-this.diff);this.tone0=RandomUtil.getMod(Constants.num_tones_in_octave);octave_ind=RandomUtil.getMod(Constants.num_octaves);for(this.tone0+=octave_ind*Constants.num_tones_in_octave;0>this.tone0+this.diff||this.tone0+this.diff>=Constants.num_tones_in_octave*Constants.num_octaves||this.tone0==IntervalHelperStatic.prev_tone0;)this.tone0=RandomUtil.getMod(Constants.num_tones_in_octave),octave_ind=RandomUtil.getMod(Constants.num_octaves),this.tone0+=octave_ind*
Constants.num_tones_in_octave;IntervalHelperStatic.prev_tone0=this.tone0},toString:function(){var a=Constants.tone_names[this.tone0%Constants.num_tones_in_octave],b=Constants.tone_names[(this.tone0+this.diff)%Constants.num_tones_in_octave],c=Math.abs(this.diff);return a+"-"+b+" ("+Constants.interval_names[c]+")"},shortName:function(){var a=Math.abs(this.diff);return Constants.interval_names[a]}};var IntervalHelperStatic={prev_tone0:0};var RandomUtil={count:0,getValue:function(){ret=Math.floor(1E6*Math.random());0>ret&&(ret=-ret);return ret},getNormalised:function(){return Math.random()},getMod:function(a){a=this.getValue()%a;100>this.count&&++this.count;return a}};var TestingHelper={testing:!1,always_true:!1};var Answers={getCorrectStr:function(a){var b=["Correct.","Right!","Yes.","Indeed.","You are right."];return b[a%b.length]},getWrongStr:function(a){var b=["Wrong.","Sorry.","No.","Oops!"];return b[a%b.length]},getShortAnswer:function(a,b,c){return a===b?this.getCorrectStr(c)+" It is "+b:this.getWrongStr(c)+" It is not "+b},getLongAnswer:function(a,b,c,d){void 0==d&&(d=a===b);a=(d?this.getCorrectStr(c):this.getWrongStr(c))+"<br>It is "+a;d||(a+=", not "+b);return a}};var Selectors={excercise:null,init:function(a){this.excercise=a;a=document.getElementsByName("selector");for(var b=0;b<a.length;++b){var c=document.createElement("span");c.className="selectortitle";var d=document.createElement("button");d.className="selectorbtn";d.textContent=">";var e=document.createElement("button");e.className="selectorbtn";e.textContent="<";var f=document.createElement("span");f.className="selectorvalue";a[b].appendChild(c);a[b].appendChild(e);a[b].appendChild(f);a[b].appendChild(d);
"keyselector"===a[b].className?(c.textContent=" Key ",d.id="keyinc",e.id="keydec",d.onclick=this.incKey,e.onclick=this.decKey,f.id="keyselectorvalue",f.textContent=Constants.tone_names[this.excercise.getRoot()]):"levelselector"===a[b].className&&(c.textContent=" Level ",d.id="levelinc",e.id="leveldec",d.onclick=this.incLevel,e.onclick=this.decLevel,f.id="levelselectorvalue",f.textContent=this.excercise.getLevel()+1)}},updateLevel:function(){document.getElementById("levelname");levelname.textContent=
Selectors.excercise.getLevelName();document.getElementById("levelselectorvalue").textContent=Selectors.excercise.getLevel()+1},incLevel:function(){Selectors.updateLevel();Selectors.excercise.setLevel((Selectors.excercise.getLevel()+1)%Selectors.excercise.getNumLevels());Selectors.excercise.draw()},decLevel:function(){Selectors.updateLevel();Selectors.excercise.setLevel((Selectors.excercise.getLevel()+Selectors.excercise.getNumLevels()-1)%Selectors.excercise.getNumLevels());Selectors.excercise.draw()},
incKey:function(){Selectors.excercise.setRoot((Selectors.excercise.getRoot()+1)%Constants.tone_names.length);Selectors.excercise.draw();document.getElementById("keyselectorvalue").textContent=Constants.tone_names[Selectors.excercise.getRoot()]},decKey:function(){Selectors.excercise.setRoot((Selectors.excercise.getRoot()+Constants.tone_names.length-1)%Constants.tone_names.length);Selectors.excercise.draw();document.getElementById("keyselectorvalue").textContent=Constants.tone_names[Selectors.excercise.getRoot()]},
enableKeySelection:function(a){var b=document.getElementById("keyinc");null!=b&&(b.disabled=!a);b=document.getElementById("keydec");null!=b&&(b.disabled=!a)},enableLevelSelection:function(a){var b=document.getElementById("levelinc");null!=b&&(b.disabled=!a);b=document.getElementById("leveldec");null!=b&&(b.disabled=!a)}};function sequencePlaySound(a){SoundManager.playSound(a)}var SequencePlayer={playing:!1,sequence:null,playSequence:function(a){if(!this.playing){this.sequence=a.slice();this.playing=!0;for(var b=a.slice(),c=function(){0!=b.length&&(sequencePlaySound(b[0]),b=b.slice(1,b.length))},d=0;d<this.sequence.length;++d)setTimeout(c,611*d);setTimeout(function(){SequencePlayer.playing=!1},611*a.length)}}};function Sequence(){this.sequence=[];this.from=0}
Sequence.prototype={Randomize:function(a,b,c){this.from=12*RandomUtil.getMod(Constants.num_octaves-1)+(b+Constants.steps_by_levels[a][RandomUtil.getMod(Constants.steps_by_levels[a].length)])%12;for(var d=[],e=0;12>=e;++e)for(var f=0;f<Constants.steps_by_levels[a].length;++f)if((this.from+e+12-b)%12==Constants.steps_by_levels[a][f]){d.push(this.from+e);break}this.sequence=Array(c);for(a=0;a<this.sequence.length;++a){b=d[RandomUtil.getMod(d.length)];c=2;5<this.sequence.length&&(c=3);for(e=c;e>c-1;){e=
0;b=d[RandomUtil.getMod(d.length)];for(f=0;f<a;++f)this.sequence[f]==b&&++e}this.sequence[a]=b}},root:function(){return this.sequence[0]},add:function(a){this.sequence.push(a)},ith:function(a){return this.sequence[a]},set_ith:function(a,b){this.sequence[a]=b},len:function(){return this.sequence.length},play:function(){SequencePlayer.playing||SequencePlayer.playSequence(this.sequence)}};var ChordTypes={maj:0,min:1,dom7:2,sus:3,maj7:4,min7:5,aug:6,dim:7,hdim7:8,dim7:9,minmaj7:10,augmaj7:11,aug7:12,num_chords:13,Name:function(a){switch(a){case ChordTypes.maj:return"Major";case ChordTypes.min:return"Minor";case ChordTypes.dim:return"Diminished";case ChordTypes.aug:return"Augmented";case ChordTypes.sus:return"Suspended";case ChordTypes.dom7:return"Dominant 7th";case ChordTypes.maj7:return"Major 7th";case ChordTypes.min7:return"Minor 7th";case ChordTypes.hdim7:return"Half-dim. 7th";case ChordTypes.dim7:return"Diminished 7th";
case ChordTypes.minmaj7:return"Minor-major 7th";case ChordTypes.augmaj7:return"Aug. major 7th";case ChordTypes.aug7:return"Augmented 7th";default:return"?"}},ShortName:function(a){switch(a){case ChordTypes.maj:return"Maj";case ChordTypes.min:return"Min";case ChordTypes.dim:return"Dim";case ChordTypes.aug:return"Aug";case ChordTypes.sus:return"Sus";case ChordTypes.dom7:return"Dom 7";case ChordTypes.maj7:return"Maj 7";case ChordTypes.min7:return"Min 7";case ChordTypes.hdim7:return"H-dim 7";case ChordTypes.dim7:return"Dim 7";
case ChordTypes.minmaj7:return"Min-maj 7";case ChordTypes.augmaj7:return"Aug maj 7";case ChordTypes.aug7:return"Aug 7";default:return"?"}}};function Chord(a,b,c){this.initInverted(a,b,c)}function intervalPlaySound(a){SoundManager.playSound(a)}
Chord.prototype={tones:null,type:0,root:0,toString:function(){for(var a=Constants.toneNameInKey(this.tones[0],this.root,!1),b=1;b<this.tones.length;++b)a+="-"+Constants.toneNameInKey(this.tones[b],this.root,!1);return a},typeToString:function(){return ChordTypes.Name(this.type)},equal:function(a){if(this.tones.length!=a.tones.length)return!1;for(a=0;a<this.tones.length;++a)if(this.tones[a]!=this.other.tones[a])return!1;return!0},randomChord:function(a){var b=7+RandomUtil.getMod(17);a=RandomUtil.getMod(Math.min(a+
2,ChordTypes.num_chords));this.init(b,a)},randomOfTwo:function(a,b){var c=RandomUtil.getMod(12)+12,d=0==RandomUtil.getMod(2)?a:b;this.init(c,d)},init:function(a,b){this.type=b;this.root=a;switch(this.type){case ChordTypes.maj:this.tones=[this.root,this.root+Constants.maj3,this.root+Constants.per5].slice();break;case ChordTypes.min:this.tones=[this.root,this.root+Constants.min3,this.root+Constants.per5].slice();break;case ChordTypes.dim:this.tones=[this.root,this.root+Constants.min3,this.root+Constants.aug4].slice();
break;case ChordTypes.aug:this.tones=[this.root,this.root+Constants.maj3,this.root+Constants.min6].slice();break;case ChordTypes.sus:this.tones=[this.root,this.root+Constants.per4,this.root+Constants.per5].slice();break;case ChordTypes.dom7:this.tones=[this.root,this.root+Constants.maj3,this.root+Constants.per5,this.root+Constants.min7].slice();break;case ChordTypes.maj7:this.tones=[this.root,this.root+Constants.maj3,this.root+Constants.per5,this.root+Constants.maj7].slice();break;case ChordTypes.min7:this.tones=
[this.root,this.root+Constants.min3,this.root+Constants.per5,this.root+Constants.min7].slice();break;case ChordTypes.hdim7:this.tones=[this.root,this.root+Constants.min3,this.root+Constants.aug4,this.root+Constants.min7].slice();break;case ChordTypes.dim7:this.tones=[this.root,this.root+Constants.min3,this.root+Constants.aug4,this.root+Constants.maj6].slice();break;case ChordTypes.minmaj7:this.tones=[this.root,this.root+Constants.min3,this.root+Constants.per5,this.root+Constants.maj7].slice();break;
case ChordTypes.augmaj7:this.tones=[this.root,this.root+Constants.maj3,this.root+Constants.min6,this.root+Constants.maj7].slice();break;case ChordTypes.aug7:this.tones=[this.root,this.root+Constants.maj3,this.root+Constants.min6,this.root+Constants.min7].slice()}},initInverted:function(a,b,c){this.init(b,c);for(b=0;b<this.tones.length;++b)for(this.tones[b]%=12;this.tones[b]<a;)this.tones[b]+=12},play:function(){if("web"==Config.target)for(var a=0;a<this.tones.length;++a)SoundManager.playSound(this.tones[a],
0.7);else 3==this.tones.length&&SoundManager.playChord3(this.tones[0],this.tones[1],this.tones[2]),4==this.tones.length&&SoundManager.playChord4(this.tones[0],this.tones[1],this.tones[2],this.tones[3])}};var SequenceChordTypes={cm_i:0,cm_neap:1,cm_III:2,cm_iv:3,cm_IV:4,cm_v:5,cm_V:6,cm_V7:7,cm_VI:8,cm_VII:9,minmaj_shift:100,c_I:100,c_ii:101,c_bIII:102,c_iii:103,c_IV:104,c_V:105,c_V7:106,c_bVI:107,c_vi:108,c_bVII:109,num_min_chords:10,num_maj_chords:10,init:function(){this.major_chords=[this.c_I,this.c_IV,this.c_V,this.c_vi,this.c_iii,this.c_V7,this.c_bIII,this.c_bVI,this.c_bVII,this.c_ii];this.minor_chords=[this.cm_i,this.cm_iv,this.cm_V,this.cm_IV,this.cm_VI,this.cm_III,this.cm_VII,this.cm_V7,this.cm_v,
this.cm_neap];this.major_chords_names="I ii bIII iii IV V V7 bVI vi bVII".split(" ");this.minor_chords_names="i IIb III iv IV v V V7 VI VII".split(" ")},chordName:function(a){return a>=this.minmaj_shift?this.major_chords_names[a-this.minmaj_shift]:this.minor_chords_names[a]},randomChord:function(a,b){var c=!0;0==a%2&&(c=!1);return 0==b?c?this.c_I:this.cm_i:c?this.major_chords[RandomUtil.getMod((a>>1)+3)]:this.minor_chords[RandomUtil.getMod((a>>1)+3)]},createChord:function(a,b,c){switch(b){case this.cm_i:return new Chord(a,
c,ChordTypes.min);case this.cm_neap:return new Chord(a,c+Constants.min2,ChordTypes.maj);case this.cm_III:return new Chord(a,c+Constants.min3,ChordTypes.maj);case this.cm_iv:return new Chord(a,c+Constants.per4,ChordTypes.min);case this.cm_IV:return new Chord(a,c+Constants.per4,ChordTypes.maj);case this.cm_v:return new Chord(a,c+Constants.per5,ChordTypes.min);case this.cm_V:return new Chord(a,c+Constants.per5,ChordTypes.maj);case this.cm_V7:return new Chord(a,c+Constants.per5,ChordTypes.dom7);case this.cm_VI:return new Chord(a,
c+Constants.min6,ChordTypes.maj);case this.cm_VII:return new Chord(a,c+Constants.min7,ChordTypes.maj);case this.c_I:return new Chord(a,c,ChordTypes.maj);case this.c_ii:return new Chord(a,c+Constants.maj2,ChordTypes.min);case this.c_iii:return new Chord(a,c+Constants.maj3,ChordTypes.min);case this.c_bIII:return new Chord(a,c+Constants.min3,ChordTypes.maj);case this.c_IV:return new Chord(a,c+Constants.per4,ChordTypes.maj);case this.c_V:return new Chord(a,c+Constants.per5,ChordTypes.maj);case this.c_V7:return new Chord(a,
c+Constants.per5,ChordTypes.dom7);case this.c_bVI:return new Chord(a,c+Constants.min6,ChordTypes.maj);case this.c_vi:return new Chord(a,c+Constants.maj6,ChordTypes.min);case this.c_bVII:return new Chord(a,c+Constants.min7,ChordTypes.maj);default:return new Chord(a,c,ChordTypes.maj)}}};function ChordSequence(a){this.root=a;this.tone0=12;this.sequence=[]}
ChordSequence.prototype={add:function(a){this.sequence.push(a)},setRoot:function(a){this.root=a},Randomize:function(a,b){this.tone0=RandomUtil.getMod(12)+6;this.sequence=[];for(var c=0;c<a;++c)if(this.sequence.push(SequenceChordTypes.randomChord(b,c)),0<c)for(;this.sequence[c]==this.sequence[c-1];)this.sequence[c]=SequenceChordTypes.randomChord(b,c)},ith:function(a){return this.sequence[a]},len:function(){return this.sequence.length},play:function(){if(!ChordSequencePlayer.playing){for(var a=[],b=
0;b<this.sequence.length;++b)a.push(SequenceChordTypes.createChord(this.tone0,this.sequence[b],this.root));ChordSequencePlayer.playSequence(a)}}};function sequencePlayChord(a){a.play()}var ChordSequencePlayer={playing:!1,sequence:null,playSequence:function(a){if(!this.playing){this.sequence=a.slice();this.playing=!0;var b=a.slice();a=function(){0!=b.length&&(sequencePlayChord(b[0]),b=b.slice(1,b.length))};for(var c=0;c<b.length;++c)setTimeout(a,611*c);setTimeout(function(){ChordSequencePlayer.playing=!1},611*b.length)}}};var ExcerciseFns={initHiscores:function(a){a.hiscores=Array(a.getNumLevels());for(var b=0;b<a.hiscores.length;++b)a.hiscores[b]=0;"web"==Config.target&&(b=window.localStorage,b[a.toString()]&&(a.hiscores=JSON.parse(b[a.toString()])));a.correct_in_row=Array(a.getNumLevels());for(b=0;b<a.correct_in_row.length;++b)a.correct_in_row[b]=0;this.updateProgress(a,!0)},resetState:function(a){this.setState(a,ExcerciseStates.pending)},clickedAnywhere:function(a){(a.state==ExcerciseStates.answered||a.state==ExcerciseStates.level_complete||
a.state==ExcerciseStates.game_over)&&this.resetState(a)},updateProgress:function(a,b){(b="undefined"===typeof b?!0:b)&&this.updateHiscores(a);var c=document.getElementsByClassName("progress_current")[0],d=Math.min(Constants.scr_w,Math.floor(this.getCorrectInRow(a)/a.getCorrectNeeded()*Constants.scr_w));c.style.width=d.toString()+"px";document.getElementsByClassName("correct_text")[0].textContent="Correct:"+this.getCorrectInRow(a).toString()+"/"+a.getCorrectNeeded();b?(c=document.getElementsByClassName("progress_hisc")[0],
d=Math.min(Constants.scr_w,Math.floor(a.hiscores[a.level]/a.getCorrectNeeded()*Constants.scr_w)),c.style.width=d.toString()+"px",document.getElementsByClassName("hiscore_text")[0].textContent="Hiscore:"+a.hiscores[a.level]):this.hideHiscores()},updateHiscores:function(a){a.hiscores[a.level]<this.getCorrectInRow(a)&&(a.hiscores[a.level]=this.getCorrectInRow(a));if("web"==Config.target){var b=window.localStorage;b[a.toString()]||(b[a.toString()]=[]);b[a.toString()]=JSON.stringify(a.hiscores)}},hideHiscores:function(){document.getElementsByClassName("progress_hisc")[0].style.width=
"0%";document.getElementsByClassName("hiscore_text")[0].textContent=""},checkLevelComplete:function(a){this.getCorrectInRow(a)==a.getCorrectNeeded()&&(a.level<a.getNumLevels()-1?(++a.level,this.setState(a,ExcerciseStates.level_complete)):this.setState(a,ExcerciseStates.game_over))},getCorrectInRow:function(a){return a.correct_in_row[a.level]},getHiscore:function(a){return a.hiscores[a.level]},playOrRepeat:function(a){return a.state!==ExcerciseStates.waiting&&a.state!==ExcerciseStates.waiting0&&a.state!==
ExcerciseStates.waiting1},setState:function(a,b){a.state=b;var c=document.getElementById("playbtn");c.textContent=this.playOrRepeat(a)?"Play":"Repeat";c.disabled=!1;Selectors.updateLevel();c=null;switch(a.state){case ExcerciseStates.pending:c=a.getPendingText();break;case ExcerciseStates.waiting:c=a.getPromptText()+"<br>"+a.getAnswerText();break;case ExcerciseStates.waiting0:c=a.getPromptText();break;case ExcerciseStates.waiting1:c=a.getPromptText()+"<br>"+a.getAnswerText();break;case ExcerciseStates.answered:c=
a.getAnsweredText();break;case ExcerciseStates.level_complete:c=a.getLevelCompleteText();break;case ExcerciseStates.game_over:c=a.getGameOverText()}Selectors.enableKeySelection(a.state==ExcerciseStates.pending||a.state==ExcerciseStates.answered);document.getElementsByClassName("infozone")[0].innerHTML=c;a.draw()}};var ExcerciseIntervals={state:0,two_intervals:null,correct_in_row:null,level:0,current_interval:0,current_answer:0,wrong_interval0:0,wrong_interval1:0,num_tries:0,entering_practice_mode:!1,exiting_practice_mode:!1,keys_h:150,keys_down:0,hiscores:0,kbrd:null,progress:null,root_text:null,init:function(){this.two_intervals=!1;this.num_tries=0;this.current_interval=new Interval;this.current_answer=new Interval;this.kbrd=new Keyboard(!1);Selectors.init(this);SequencePlayer.playing=!1;ExcerciseFns.initHiscores(this);
ExcerciseFns.resetState(this);this.setLevel(0)},toString:function(){return"excerciseintervals"},setLevel:function(a){this.level=a;this.two_intervals&&(this.two_intervals=!1,this.correct_in_row[this.level]=0);ExcerciseFns.setState(this,ExcerciseStates.pending)},getLevel:function(){return this.level},getLevelName:function(){if(!this.two_intervals)return"";var a=Math.abs(this.wrong_interval0),b=Math.abs(this.wrong_interval1);if(a>b)var c=a,a=b,b=c;return Constants.interval_names[a]+" / "+Constants.interval_names[b]},
getNumLevels:function(){return Constants.intervals.length-1},mouseMove:function(){},mouseDown:function(a,b){var c=document.getElementById("playbtn");c.offsetLeft<a&&c.offsetLeft+c.clientWidth>=a&&c.offsetTop<b&&c.offsetTop+c.clientHeight>=b||(ExcerciseFns.clickedAnywhere(this),this.keyPressed(this.kbrd.keyHitTest(a,b,this.getKeyboardFocusX())),this.draw(),setTimeout(ExcerciseIntervals.mouseUp,600))},mouseUp:function(){this.kbrd.mouseUp();this.draw()},newTask:function(){this.two_intervals?this.current_interval.randomOfTwo(this.wrong_interval0,
this.wrong_interval1):this.current_interval.randomInterval(this.getLevel())},playTask:function(){if(this.state==ExcerciseStates.pending||this.state==ExcerciseStates.level_complete||this.state==ExcerciseStates.game_over)this.newTask(),ExcerciseFns.setState(this,ExcerciseStates.waiting0);this.current_interval.play();this.draw()},isActive:function(a){if(this.getLevel()==this.getNumLevels())return!0;if(this.state==ExcerciseStates.pending)return!1;var b=this.current_interval.tone0,c=a-b;if(a==b)return!0;
if(this.two_intervals)return Math.abs(c)==Math.abs(this.wrong_interval0)||Math.abs(c)==Math.abs(this.wrong_interval1);for(a=0;a<this.getLevel()+2;++a)if(Constants.intervals[a]==Math.abs(c))return!0;return!1},keyPressed:function(a){0>a||(SoundManager.playSound(a),this.state==ExcerciseStates.waiting0&&this.isActive(a)?a==this.current_interval.tone0&&(++this.num_tries,this.current_answer.tone0=a,ExcerciseFns.setState(this,ExcerciseStates.waiting1)):this.state==ExcerciseStates.waiting1&&this.isActive(a)&&
a!=this.current_interval.tone0&&(++this.num_tries,this.current_answer.diff=a-this.current_answer.tone0,TestingHelper.always_true||this.current_answer.equal(this.current_interval)?++this.correct_in_row[this.level]:(this.correct_in_row[this.level]=0,0<this.getLevel()&&(!this.two_intervals&&Math.abs(this.current_interval.diff)!=Math.abs(this.current_answer.diff))&&(this.two_intervals=!0,this.wrong_interval0=this.current_answer.diff,this.wrong_interval1=this.current_interval.diff,this.entering_practice_mode=
!0)),ExcerciseFns.updateProgress(this,!this.two_intervals),this.two_intervals?(this.correct_in_row[this.level]>=this.getCorrectNeeded()&&(this.correct_in_row[this.level]=0,this.two_intervals=!1,this.exiting_practice_mode=!0),ExcerciseFns.setState(this,ExcerciseStates.answered)):(ExcerciseFns.setState(this,ExcerciseStates.answered),ExcerciseFns.checkLevelComplete(this)),this.draw()))},getCorrectNeeded:function(){return TestingHelper.testing?1:this.two_intervals?10:4>this.getLevel()?15:8>this.getLevel()?
25:30},getAnswerText:function(){return Answers.getLongAnswer(Constants.toneName(this.current_interval.tone0),Constants.toneName(this.current_answer.tone0),this.num_tries+this.current_interval.tone0,this.current_interval.tone0==this.current_answer.tone0)},getPromptText:function(){var a=Constants.toneName(this.current_interval.tone0)+" - ?";this.state==ExcerciseStates.waiting0&&(a+="<br> Play the two tones on the keyboard.");return a},getPendingText:function(){return"Press play to hear interval."},
getAnsweredText:function(){var a=Answers.getLongAnswer(this.current_interval.toString(),this.current_answer.toString(),this.num_tries+this.current_interval.tone0,this.current_answer.equal(this.current_interval));return this.entering_practice_mode?(this.entering_practice_mode=!1,a+"<br>Let's practice these two intervals a bit."):this.exiting_practice_mode?(this.exiting_practice_mode=!1,a+"<br>Enough with these two intervals."):a+"<br>Press play to hear next interval"},getLevelCompleteText:function(){var a=
"Level "+(this.getLevel()+1)+"<br>New interval: ";return a+=Constants.interval_names[Constants.intervals[this.getLevel()+1]]},getGameOverText:function(){return"Congratulations, great job!<br> It doesn't get any harder than this."},draw:function(){ExcerciseFns.updateProgress(this,!this.two_intervals);document.getElementById("canvas").getContext("2d").clearRect(0,0,Constants.scr_w,Constants.scr_h);this.drawKeys(0,KbdMeasurements.getKeyDisplayH())},getKeyboardFocusX:function(){var a=0;-1!=this.current_interval.tone0&&
(a=0,a=0<=this.current_interval.diff?this.current_interval.tone0:Math.max(0,this.current_interval.tone0-12),a=KbdMeasurements.getKeyDisplayX(a),a+Constants.scr_w>KbdMeasurements.getRightBorderX()&&(a=KbdMeasurements.getRightBorderX()-Constants.scr_w));return a},getKeyStates:function(){for(var a=[],b=0;b<Constants.num_octaves;++b)for(var c=0;c<Constants.num_tones_in_octave;++c)a.push(this.isActive(c+b*Constants.num_tones_in_octave));return a},drawKeys:function(a,b){var c=this.getKeyboardFocusX(),d=
this.getKeyStates();this.kbrd.draw(c,b,d);this.state===ExcerciseStates.waiting0||this.state===ExcerciseStates.waiting1?this.kbrd.subscribeKey(this.current_interval.tone0,this.getKeyboardFocusX()):this.kbrd.hideSubscribeKey()}};var ExcercisePerfect={state:0,level:0,two_tones:null,prev_tone:0,current_tone:0,current_answer:0,wrong_tone0:0,wrong_tone1:0,num_tries:0,entering_practice_mode:!1,exiting_practice_mode:!1,keys_down:0,progress:null,kbrd:null,init:function(){this.two_tones=!1;this.num_tries=0;this.current_answer=this.prev_tone=this.current_tone=-1;this.kbrd=new Keyboard(!0);Selectors.init(this);ExcerciseFns.initHiscores(this);ExcerciseFns.resetState(this);this.setLevel(0)},toString:function(){return"excerciseperfect"},
setLevel:function(a){this.level=a;this.two_tones&&(this.two_tones=!1,this.correct_in_row[this.level]=0);ExcerciseFns.setState(this,ExcerciseStates.pending)},getLevel:function(){return this.level},getLevelName:function(){if(!this.two_tones)return"";var a=this.wrong_tone0,b=this.wrong_tone1;if(a>b)var c=a,a=b,b=c;return Constants.generalToneName(a)+" / "+Constants.generalToneName(b)},getNumLevels:function(){return 11},mouseMove:function(){},getKeyboardFocusX:function(){var a=0,a=12*this.getOctaveIndex(),
a=KbdMeasurements.getKeyDisplayX(a);a+Constants.scr_w>KbdMeasurements.getRightBorderX()&&(a=KbdMeasurements.getRightBorderX()-Constants.scr_w);return a},getOctaveIndex:function(){return-1!=this.current_tone?Math.floor(this.current_tone/12):0},mouseDown:function(a,b){var c=document.getElementById("playbtn");c.offsetLeft<a&&c.offsetLeft+c.clientWidth>=a&&c.offsetTop<b&&c.offsetTop+c.clientHeight>=b||(ExcerciseFns.clickedAnywhere(this),this.keyPressed(this.kbrd.keyHitTest(a,b,this.getKeyboardFocusX())),
this.draw(),setTimeout(ExcercisePerfect.mouseUp,600))},mouseUp:function(){this.kbrd.mouseUp();this.draw()},newTask:function(){this.current_tone=this.randomTone()},randomTone:function(){for(var a=this.current_tone;a==this.current_tone;)a=this._randomTone();return a},_randomTone:function(){var a=RandomUtil.getMod(Constants.num_octaves);if(this.two_tones){var b=RandomUtil.getMod(2);return(0==b?this.wrong_tone0:this.wrong_tone1)+a*Constants.num_tones_in_octave}b=Math.min(this.level,Constants.num_levels-
1)+2;b=RandomUtil.getMod(b);return Constants.tones[b]+a*Constants.num_tones_in_octave},clickedAnywhere:function(){(this.state==ExcerciseStates.answered||this.state==ExcerciseStates.level_complete)&&ExcerciseFns.setState(this,ExcerciseStates.pending)},playTask:function(){if(this.state==ExcerciseStates.pending||this.state==ExcerciseStates.level_complete||this.state==ExcerciseStates.game_over)this.newTask(),ExcerciseFns.setState(this,ExcerciseStates.waiting);SoundManager.playSound(this.current_tone);
this.draw()},isActive:function(a){a%=Constants.num_tones_in_octave;if(this.two_tones)return a==this.wrong_tone0||a==this.wrong_tone1;for(var b=0;b<this.level+2;++b)if(Constants.tones[b]==a)return!0;return!1},keyPressed:function(a){-1!=a&&(SoundManager.playSound(a),this.state==ExcerciseStates.waiting&&this.isActive(a)&&(++this.num_tries,this.current_answer=a,TestingHelper.always_true||this.current_answer==this.current_tone?++this.correct_in_row[this.level]:(this.correct_in_row[this.level]=0,0<this.level&&
(!this.two_tones&&this.current_answer%Constants.num_tones_in_octave!=this.current_tone%Constants.num_tones_in_octave)&&(this.two_tones=!0,this.wrong_tone0=this.current_answer%Constants.num_tones_in_octave,this.wrong_tone1=this.current_tone%Constants.num_tones_in_octave,this.entering_practice_mode=!0)),ExcerciseFns.updateProgress(this,!this.two_tones),this.two_tones?(this.correct_in_row[this.level]>=this.getCorrectNeeded()&&(this.correct_in_row[this.level]=0,this.two_tones=!1,this.exiting_practice_mode=
!0),ExcerciseFns.setState(this,ExcerciseStates.answered)):(ExcerciseFns.setState(this,ExcerciseStates.answered),ExcerciseFns.checkLevelComplete(this))),this.draw())},getCorrectInRow:function(){return this.correct_in_row[this.level]},getCorrectNeeded:function(){return TestingHelper.testing?1:this.two_tones?10:4>this.level?20:8>this.level?25:30},getPromptText:function(){return"What tone is it?"},getPendingText:function(){return"Press play to hear tone."},getAnswerText:function(){return""},getAnsweredText:function(){var a=
Answers.getLongAnswer(Constants.longToneName(this.current_tone),Constants.longToneName(this.current_answer),this.num_tries+this.current_tone);return this.entering_practice_mode?(this.entering_practice_mode=!1,a+"<br>Let's practice these two tones a bit."):this.exiting_practice_mode?(this.exiting_practice_mode=!1,a+"<br>Enough with these two tones."):a+"<br>Press play to hear next tone"},getLevelCompleteText:function(){return"Level "+(this.level+1)+"<br>New tone: "+Constants.tone_names[Constants.tones[this.level+
1]]},getGameOverText:function(){return"Congratulations, great job!<br> It doesn't get any harder than this."},draw:function(){ExcerciseFns.updateProgress(this,!this.two_tones);this.context=document.getElementById("canvas").getContext("2d");this.context.clearRect(0,0,Constants.scr_w,Constants.scr_h);this.drawKeys(0,KbdMeasurements.getKeyDisplayH())},getKeyStates:function(){for(var a=[],b=0;b<Constants.num_octaves;++b)for(var c=0;c<Constants.num_tones_in_octave;++c)a.push(this.isActive(c+b*Constants.num_tones_in_octave));
return a},drawKeys:function(a,b){var c=this.getKeyboardFocusX(),d=this.getKeyStates();this.kbrd.draw(c,b,d);KbdMeasurements.getNumKeysOnScreen()<7*Constants.num_octaves&&this.kbrd.subscribeKeyFull(12*this.getOctaveIndex(),this.getKeyboardFocusX())}};var ExcerciseMelody={root:0,num_tries:0,state:0,level:0,length:0,mistaken:!1,current_seq:null,current_answer:null,wrong_tone:null,kbrd:null,init:function(){this.root=this.num_tries=0;this.length=5;Selectors.init(this);this.kbrd=new Keyboard(!1);ExcerciseFns.initHiscores(this);ExcerciseFns.resetState(this);SequencePlayer.playing=!1;this.setLevel(0)},toString:function(){return"excercisemelody"},setRoot:function(a){this.root=a;ExcerciseFns.setState(this,ExcerciseStates.pending)},getRoot:function(){return this.root},
setLevel:function(a){this.level=a;ExcerciseFns.setState(this,ExcerciseStates.pending)},getLevelName:function(){return Constants.level_names[this.level]},newTask:function(){this.current_seq=new Sequence;this.current_seq.Randomize(this.level,this.root,this.length);this.current_answer=new Sequence(0);this.mistaken=!1},playTask:function(){if(this.state==ExcerciseStates.pending||this.state==ExcerciseStates.level_complete||this.state==ExcerciseStates.game_over)this.newTask(),ExcerciseFns.setState(this,
ExcerciseStates.waiting);this.current_seq.play();this.draw()},isActive:function(a){for(var b=0;b<Constants.steps_by_levels[this.level].length;++b)if((a+Constants.num_tones_in_octave-this.root)%Constants.num_tones_in_octave==Constants.steps_by_levels[this.level][b])return!0;return!1},keyPressed:function(a){0>a||(SoundManager.playSound(a),this.state==ExcerciseStates.waiting&&this.isActive(a)&&(++this.num_tries,a!==this.current_seq.ith(this.current_answer.len())&&!TestingHelper.always_true?(this.correct_in_row[this.getLevel()]=
0,this.wrong_tone=a,this.mistaken=!0):this.wrong_tone=null,null==this.wrong_tone&&this.current_answer.add(a),ExcerciseFns.setState(this,ExcerciseStates.waiting),this.current_answer.len()==this.current_seq.len()&&(this.mistaken||++this.correct_in_row[this.getLevel()],ExcerciseFns.updateProgress(this),ExcerciseFns.setState(this,ExcerciseStates.answered),ExcerciseFns.checkLevelComplete(this))))},getCorrectNeeded:function(){return TestingHelper.testing?1:5>this.level?5:10>this.level?7:15>this.level?10:
20>this.level?15:1E4},getLevel:function(){return this.level},getNumLevels:function(){return Constants.getNumMelodyLevels()},getKeyStates:function(){for(var a=[],b=0;b<Constants.num_octaves;++b)for(var c=0;c<Constants.num_tones_in_octave;++c)a.push(this.isActive(c+b*Constants.num_tones_in_octave));return a},toneName:function(a){return Constants.toneNameInKey(a,this.root,Constants.isMajor(this.level))},longToneName:function(a){return Constants.longToneNameInKey(a,this.root,Constants.isMajor(this.level))},
getAnswerText:function(){if(0==this.current_answer.len())return"";var a=this.current_seq.ith(this.current_answer.len()-1),b=null==this.wrong_tone?this.current_answer.ith(this.current_answer.len()-1):this.wrong_tone;return Answers.getShortAnswer(this.longToneName(a),this.longToneName(b),this.num_tries+this.current_seq.root())},getPromptText:function(){for(var a=this.toneName(this.current_seq.sequence[0]),b=1;b<this.current_seq.len();++b)a=b<this.current_answer.len()&&this.current_answer.ith(b)==this.current_seq.ith(b)?
a+(" - "+this.toneName(this.current_answer.ith(b))):a+" - ?";return a},getPendingText:function(){return"Press play to hear melody"},getAnsweredText:function(){var a="";return a=this.mistaken?"There were some mistakes.<br>Press play to hear melody":"That was correct.<br>Press play to hear next melody"},getLevelCompleteText:function(){return"Level "+(ex.level+1)+" <br>Press play to hear melody."},getGameOverText:function(){return"Congratulations, great job!<br> It doesn't get any harder than this."},
getKeyboardFocusX:function(){var a=0;null!=this.current_seq&&(a=KbdMeasurements.getKeyDisplayX(this.current_seq.from),a+Constants.scr_w>KbdMeasurements.getRightBorderX()&&(a=KbdMeasurements.getRightBorderX()-Constants.scr_w));return a},draw:function(){ExcerciseFns.updateProgress(this);var a=document.getElementById("canvas"),b=a.getContext("2d");a.width=a.width;b.clearRect(0,0,a.width,a.height);b.fillStyle="black";b.fillRect(0,0,a.width,a.height);this.drawKeys(0,KbdMeasurements.getKeyDisplayH())},
drawKeys:function(a,b){var c=this.getKeyboardFocusX(),d=this.getKeyStates();this.kbrd.draw(c,b,d);this.state===ExcerciseStates.waiting?this.kbrd.subscribeKey(this.current_seq.sequence[0],this.getKeyboardFocusX()):this.kbrd.hideSubscribeKey()},mouseMove:function(){},mouseUp:function(){ExcerciseMelody.kbrd.mouseUp();ExcerciseMelody.draw()},mouseDown:function(a,b){this.keyPressed(this.kbrd.keyHitTest(a,b,this.getKeyboardFocusX()));this.draw();setTimeout(ExcerciseMelody.mouseUp,600)}};var ExcerciseChordTypes={state:0,two_chords:null,correct_in_row:null,level:0,current_chord:0,current_answer:0,wrong_type0:0,wrong_type1:0,num_tries:0,chord_btns:0,progress:null,kbrd:null,entering_practice_mode:!1,exiting_practice_mode:!1,init:function(){this.two_chords=!1;this.num_tries=0;this.current_chord=new Chord(12,12,0);this.current_answer=new Chord(12,12,0);for(var a=0;a<ChordTypes.num_chords;++a){var b=document.getElementById(ChordTypes.ShortName(a));b.textContent=ChordTypes.Name(a);b.onclick=
function(a){return function(){ExcerciseChordTypes.buttonDown(a)}}(a)}Selectors.init(this);ExcerciseFns.initHiscores(this);ExcerciseFns.resetState(this);this.setLevel(0)},toString:function(){return"excercisechordtypes"},setLevel:function(a){this.level=a;this.two_chords&&(this.two_chords=!1,this.correct_in_row[this.level]=0);ExcerciseFns.setState(this,ExcerciseStates.pending);this.updateBtnEnabling()},getLevel:function(){return this.level},newTask:function(){this.two_chords?this.current_chord.randomOfTwo(this.wrong_type0,
this.wrong_type1):this.current_chord.randomChord(this.getLevel())},playTask:function(){if(this.state==ExcerciseStates.pending||this.state==ExcerciseStates.level_complete||this.state==ExcerciseStates.game_over)this.newTask(),ExcerciseFns.setState(this,ExcerciseStates.waiting);this.current_chord.play();this.draw()},getNumLevels:function(){return ChordTypes.num_chords-1},mouseUp:function(){},mouseMove:function(){},buttonDown:function(a){a=new Chord(this.current_chord.root,this.current_chord.root,a);
a.play();this.state==ExcerciseStates.waiting&&(this.current_answer=a,TestingHelper.always_true||this.current_answer.type==this.current_chord.type?++this.correct_in_row[this.level]:(this.correct_in_row[this.level]=0,0<this.level&&!this.two_chords&&(this.two_chords=!0,this.wrong_type0=this.current_answer.type,this.wrong_type1=this.current_chord.type,this.entering_practice_mode=!0)),ExcerciseFns.updateProgress(this,!this.two_chords),this.two_chords?(this.correct_in_row[this.level]>=this.getCorrectNeeded()&&
(this.correct_in_row[this.level]=0,this.two_chords=!1,this.exiting_practice_mode=!0),ExcerciseFns.setState(this,ExcerciseStates.answered)):(ExcerciseFns.setState(this,ExcerciseStates.answered),ExcerciseFns.checkLevelComplete(this)))},getLevelName:function(){if(!this.two_chords)return"";var a=Math.abs(this.wrong_type0),b=Math.abs(this.wrong_type1);if(a>b)var c=a,a=b,b=c;return ChordTypes.Name(a)+" / "+ChordTypes.Name(b)},mouseDown:function(a,b){var c=document.getElementById("playbtn");c.offsetLeft<
a&&c.offsetLeft+c.clientWidth>=a&&c.offsetTop<b&&c.offsetTop+c.clientHeight>=b||(ExcerciseFns.clickedAnywhere(this),this.updateBtnEnabling())},getCorrectInRow:function(){return this.correct_in_row},getCorrectNeeded:function(){return TestingHelper.testing?1:this.two_chords?10:4>this.getLevel()?15:8>this.getLevel()?25:40},updateBtnEnabling:function(){for(var a=0;a<ChordTypes.num_chords;++a){var b=document.getElementById(ChordTypes.ShortName(a));b.disabled=!(a<=this.getLevel()+1);this.two_chords&&(b.disabled=
!(a==this.wrong_type0||a==this.wrong_type1))}},subscribeChord:function(){},getPromptText:function(){return"What chord is it?"},getPendingText:function(){return"Press play to hear chord."},getAnswerText:function(){return""},getAnsweredText:function(){var a=Answers.getLongAnswer(this.current_chord.typeToString(),this.current_answer.typeToString(),this.num_tries+this.current_chord.type);return this.entering_practice_mode?(this.entering_practice_mode=!1,a+"<br>Let's practice these two chords a bit."):
this.exiting_practice_mode?(this.exiting_practice_mode=!1,a+"<br>Enough with these two chords."):a+"<br>Press play to hear next chord"},getLevelCompleteText:function(){return"Level "+(this.level+1)+"<br>New chord: "+ChordTypes.Name(this.getLevel()+1)},getGameOverText:function(){return"Congratulations, great job!<br> It doesn't get any harder than this."},draw:function(){ExcerciseFns.updateProgress(this,!this.two_chords);this.updateBtnEnabling()}};var ExcerciseChords={state:0,level:0,correct_in_row:0,mistaken:0,wrong_chord:0,num_tries:0,root:0,seq:null,current_seq:null,current_answer:null,chord_btns:null,key_selector:null,init:function(){this.root=this.num_tries=0;Selectors.init(this);ExcerciseFns.initHiscores(this);ExcerciseFns.resetState(this);ChordSequencePlayer.playing=!1;this.setLevel(0);this.resetButtonLabels();this.newTask()},toString:function(){return"excercisechords"},resetButtonLabels:function(){for(var a=document.getElementById("chords");;){var b=
document.getElementsByClassName("chord_progression_btn");if(0==b.length)break;a.removeChild(b[0])}var b=a.clientWidth,c=a.clientHeight,d=-1,e=-1,f=0,j=this.isLevelMajor()?SequenceChordTypes.num_maj_chords:SequenceChordTypes.num_min_chords;this.chord_btns=Array(j);for(var g=0;g<j;++g){var h=Math.floor(b/7);this.isLevelMajor()&&(h=Math.floor(b/9));var k=Math.floor(c/3)-2,l=g;this.isLevelMajor()&&(l+=SequenceChordTypes.minmaj_shift);var m=SequenceChordTypes.createChord(12,l,this.root),n=m.root-this.root;
e!=n?(++d,f=0):++f;e=n;this.chord_btns[g]=document.createElement("button");this.chord_btns[g].className="chord_progression_btn";this.chord_btns[g].style.left=(d%12*h).toString()+"px";this.chord_btns[g].style.top=(f*(k+2)).toString()+"px";this.chord_btns[g].style.width=h.toString()+"px";this.chord_btns[g].style.height=k.toString()+"px";this.chord_btns[g].disabled=!0;for(h=0;h<(this.getCorrectedLevel()>>1)+3;++h)this.isLevelMajor()?SequenceChordTypes.major_chords[h]==g+SequenceChordTypes.minmaj_shift&&
(this.chord_btns[g].disabled=!1):SequenceChordTypes.minor_chords[h]==g&&(this.chord_btns[g].disabled=!1);l=SequenceChordTypes.chordName(l)+"<br>"+Constants.toneNameInKey(m.root,this.root,0!=this.getCorrectedLevel()%2);m.type==ChordTypes.min&&(l+="m");m.type==ChordTypes.dom7&&(l+="7");this.chord_btns[g].innerHTML=l;this.chord_btns[g].onmousedown=function(a){return function(){console.log("mouse down"+a.toString());ExcerciseChords.buttonDown(a)}}(g);a.appendChild(this.chord_btns[g])}},setLevel:function(a){this.level=
a;this.resetButtonLabels();ExcerciseFns.setState(this,ExcerciseStates.pending)},newTask:function(){this.current_seq=new ChordSequence(this.root,0,this.getCorrectedLevel());this.current_seq.Randomize(4,this.getCorrectedLevel(),this.root);this.current_answer=new ChordSequence(this.root,0,this.getCorrectedLevel());this.mistaken=!1},playTask:function(){if(this.state==ExcerciseStates.pending||this.state==ExcerciseStates.level_complete||this.state==ExcerciseStates.game_over)this.newTask(),ExcerciseFns.setState(this,
ExcerciseStates.waiting);this.current_seq.play()},getNumLevels:function(){return SequenceChordTypes.num_min_chords+SequenceChordTypes.num_maj_chords-4},setRoot:function(a){this.root=a;this.resetButtonLabels()},getRoot:function(){return this.root},mouseMove:function(){},mouseUp:function(){},buttonDown:function(a){ChordSequencePlayer.playing||(this.isLevelMajor()&&(a+=SequenceChordTypes.minmaj_shift),SequenceChordTypes.createChord(this.current_seq.tone0,a,this.root).play(),this.state==ExcerciseStates.waiting&&
(++this.num_tries,a!==this.current_seq.sequence[this.current_answer.len()]&&!TestingHelper.always_true?(this.correct_in_row[this.level]=0,this.mistaken=!0,this.wrong_chord=a):(this.current_answer.add(a),this.wrong_chord=null),ExcerciseFns.setState(this,ExcerciseStates.waiting),this.current_answer.len()==this.current_seq.len()&&(this.mistaken||++this.correct_in_row[this.level],ExcerciseFns.updateProgress(this),ExcerciseFns.setState(this,ExcerciseStates.answered),ExcerciseFns.checkLevelComplete(this))))},
mouseDown:function(){this.draw()},getLevel:function(){return this.level},getLevelName:function(){return""},getCorrectInRow:function(){return this.correct_in_row[this.level]},getCorrectNeeded:function(){return TestingHelper.testing?1:5>this.getLevel()?7:10>this.getLevel()?10:16>this.getLevel()?15:1E4},getCorrectedLevel:function(){return Math.min(this.getLevel(),this.getNumLevels()-1)},isLevelMajor:function(){return 0!=this.getCorrectedLevel()%2},extendedName:function(a){var b=SequenceChordTypes.createChord(12,
a,this.root);a=SequenceChordTypes.chordName(a);a+=" ("+Constants.toneNameInKey(b.root,this.root,this.isLevelMajor());b.type==Chord.min&&(a+="m");b.type==Chord.dom7&&(a+="7");return a+")"},getAnswerText:function(){if(0==this.current_answer.len())return"";var a=this.current_seq.sequence[this.current_answer.len()-1],b=null==this.wrong_chord?this.current_answer.sequence[this.current_answer.len()-1]:this.wrong_chord;return Answers.getShortAnswer(this.extendedName(a),this.extendedName(b),this.num_tries+
this.current_seq.root)},getPromptText:function(){var a;a=""+SequenceChordTypes.chordName(this.current_seq.sequence[0]);for(var b=1;b<this.current_seq.len();++b)a=b<this.current_answer.len()?a+(" - "+this.extendedName(this.current_seq.sequence[b])):a+" - ?";return a},getPendingText:function(){return"Press play to hear chord progression."},getAnsweredText:function(){var a=null;return a=this.mistaken?"There were some mistakes.<br>Press play to hear progression":"That was correct.<br>Press play to hear next progression"},
getLevelCompleteText:function(){var a="Level "+(this.level+1);return a+"<br>Press play to hear chord progression"},getGameOverText:function(){return"Congratulations, great job!<br> It doesn't get any harder than this."},draw:function(){ExcerciseFns.updateProgress(this);this.resetButtonLabels()},playOrRepeat:function(){return this.state!=ExcerciseStates.waiting}};var KbdMeasurements={width:0,height:0,num_keys_on_screen:0,init:function(a,b){this.width=a;this.height=b;"web"==Config.target?this.num_keys_on_screen=7*Constants.num_octaves:(this.num_keys_on_screen=Math.floor(DeviceMeasurements.widthInches()/(3/9)),this.num_keys_on_screen>7*Constants.num_octaves&&(this.num_keys_on_screen=7*Constants.num_octaves),8>this.num_keys_on_screen&&(this.num_keys_on_screen=8))},getKeyXSrc:function(a){for(var b=a%Constants.num_tones_in_octave,c=this.width/7,d=0,e=0;e<b;++e)Constants.isBlack(a),
Constants.isBlack(e),Constants.isBlack(a)==Constants.isBlack(e)&&++d;return Math.floor(c*d)},getKeyYSrc:function(a){return Constants.isBlack(a)?Math.floor(2*this.height/3):0},getKeyWSrc:function(){return Math.floor(this.width/7)+1},getKeyHSrc:function(a){return Math.floor(Constants.isBlack(a)?this.height/3:2*(this.height/3))},getKeyDisplayX:function(a){for(var b=0,c=0;c<a%12;++c)Constants.isBlack(c)||b++;b=Math.floor(this.getKeyDisplayWFloat()*b+1);Constants.isBlack(a)&&(b-=Math.floor(this.getKeyDisplayWFloat()/
2));return b+Math.floor(7*Math.floor(a/12)*this.getKeyDisplayWFloat())},getRightBorderX:function(){return 21*this.getKeyDisplayWFloat()},getKeyDisplayY:function(){return 0},getNumKeysOnScreen:function(){return this.num_keys_on_screen},getKeyDisplayWFloat:function(){return Constants.scr_w/this.getNumKeysOnScreen()},getKeyDisplayW:function(){return Math.floor(this.getKeyDisplayWFloat())},getKeyDisplayH:function(a){var b=this.getBlackKeyHeight();return Constants.isBlack(a)?b:2*b},getBlackKeyHeight:function(){return Math.floor(Constants.scr_h/
2)}};function Keyboard(){this.keysactive_img=AnimationManager.CreateKeysGreenAnim();this.keysdisabled_img=AnimationManager.CreateKeysDisabledAnim();this.keyspressed_img=AnimationManager.CreateKeysDisabledPressedAnim();this.keyspressedactive_img=AnimationManager.CreateKeysGreenPressedAnim();this.canvas=document.getElementById("canvas");this.context=this.canvas.getContext("2d");this.keys_down=[];for(var a=0;a<Constants.num_octaves;++a)for(var b=0;b<Constants.num_tones_in_octave;++b)this.keys_down.push(!1);
KbdMeasurements.init(this.keysactive_img.width,this.keysactive_img.height)}
Keyboard.prototype={play_y:70,play_x:210,play_w:120,play_h:42,Init:function(){},keyHitTest:function(a,b,c){a+=c;c=this.keysAnimated(0);var d=document.createElement("canvas"),e=d.getContext("2d");a-=this.canvas.offsetLeft;b-=this.canvas.offsetTop;for(var f=0;f<Constants.num_tones_in_octave*Constants.num_octaves;++f){var j=KbdMeasurements.getKeyDisplayX(f),g=KbdMeasurements.getKeyDisplayY(),h=KbdMeasurements.getKeyDisplayW(),k=KbdMeasurements.getKeyDisplayH(f);if(a>j&&(a<j+h&&b>g&&b<g+k)&&(j=(a-j)/
h,h=(b-g)/k,g=KbdMeasurements.getKeyWSrc(),k=KbdMeasurements.getKeyHSrc(f),j=Math.floor(j*g),h=Math.floor(h*k),d.width=g,d.height=k,e.drawImage(c,KbdMeasurements.getKeyXSrc(f),KbdMeasurements.getKeyYSrc(f),g,k,0,0,g,k),0!=e.getImageData(1,1,d.width,d.height).data[Math.floor(4*(h*g+j))+3]))return this.keys_down[f]=!0,f}return-1},mouseUp:function(){for(var a=0;a<this.keys_down.length;++a)this.keys_down[a]=!1},drawBackground:function(a){this.context.drawImage(this.bkghi,0,0);this.context.drawImage(this.bkglo,
0,(Constants.key_h0+Constants.key_h1)*Constants.key_scale+a)},keysAnimated:function(a,b){return a?b?this.keyspressedactive_img:this.keysactive_img:b?this.keyspressed_img:this.keysdisabled_img},drawKey:function(a,b,c,d,e){b=this.keysAnimated(d,e);document.getElementById("canvas").getContext("2d").drawImage(b,KbdMeasurements.getKeyXSrc(c),KbdMeasurements.getKeyYSrc(c),KbdMeasurements.getKeyWSrc(),KbdMeasurements.getKeyHSrc(c),KbdMeasurements.getKeyDisplayX(c)-a,KbdMeasurements.getKeyDisplayY(),KbdMeasurements.getKeyDisplayW(),
KbdMeasurements.getKeyDisplayH(c))},draw:function(a,b,c){for(var d=0;d<c.length;++d)this.drawKey(a,b,d,c[d],this.keys_down[d])},hideSubscribeKey:function(){document.getElementsByClassName("roottext")[0].textContent=""},subscribeKey:function(a,b){var c=document.getElementsByClassName("roottext")[0];c.style.left=(KbdMeasurements.getKeyDisplayX(a)-b).toString()+"px";var d=KbdMeasurements.getKeyDisplayY()+Math.floor(KbdMeasurements.getBlackKeyHeight()/2);Constants.isBlack(a)||(d+=KbdMeasurements.getBlackKeyHeight());
var e=Math.floor(KbdMeasurements.getKeyDisplayW()/2);c.style.top=(d-Math.floor(e/2)).toString()+"px";c.style.width=KbdMeasurements.getKeyDisplayW().toString()+"px";c.textContent=Constants.toneName(a)},subscribeKeyFull:function(a,b){var c=document.getElementsByClassName("octavetext")[0];c.style.left=(KbdMeasurements.getKeyDisplayX(a)-b).toString()+"px";var d=KbdMeasurements.getKeyDisplayY()+Math.floor(KbdMeasurements.getBlackKeyHeight()/2);Constants.isBlack(a)||(d+=KbdMeasurements.getBlackKeyHeight());
var e=Math.floor(KbdMeasurements.getKeyDisplayW()/2);c.style.top=(d-Math.floor(e/2)).toString()+"px";c.style.width=KbdMeasurements.getKeyDisplayW().toString()+"px";c.textContent=Constants.longToneName(a)}};Config.target="undefined"!==typeof SoundManagerAndroid?"android":"web";var ex=null;function touchDown(a){a=a.touches[0];ex.mouseDown(a.clientX,a.clientY)}function touchUp(){ex.mouseUp()}function mouseDown(a){ex.mouseDown(a.clientX,a.clientY)}function mouseUp(a){ex.mouseUp(a.clientX,a.clientY)}"web"==Config.target?(document.onmousedown=mouseDown,document.onmouseup=mouseUp):(document.ontouchstart=touchDown,document.ontouchend=touchUp);
function removeStub(){var a=document.getElementsByClassName("excercise")[0],b=document.getElementsByClassName("stub");0<b.length&&(b=b[0],a.removeChild(b))}
"web"==Config.target&&(window.onresize=function(){if(SoundManager.canPlayAudio()){var a=document.getElementById("canvas"),b=document.getElementsByClassName("excercise")[0];a?(a.width=b.clientWidth,a.height=Math.floor(0.5*b.clientHeight),a.style.width=b.clientWidth,a.style.height=Math.floor(0.5*b.clientHeight),Constants.scr_w=a.clientWidth,Constants.scr_h=a.clientHeight):(Constants.scr_w=b.clientWidth,Constants.scr_h=b.clientHeight);null!=ex&&ex.draw()}});window.onselectstart=function(){return!1};
var t,reloaded=!1;function drawFlush(){var a=document.getElementsByClassName("excercise")[0],b=document.getElementsByClassName("loader");0<b.length&&(b=b[0],a.removeChild(b));b=document.getElementById("canvas");null!=b?(b.width=a.clientWidth,b.height=Math.floor(0.5*a.clientHeight)):(Constants.scr_w=a.clientWidth,Constants.scr_h=a.clientHeight);Constants.init();ex.init();ex.draw()}function loadProgress(a){document.getElementsByClassName("loader")[0].innerHTML="Loading "+a.toString()+"%"}
function onLoad(a){ex=a;a=document.getElementsByClassName("excercise")[0];"web"==Config.target?a.style.height="320px":(a.style.width="100%",document.getElementsByClassName("upper")[0].style.borderRadius="0",a.style.borderRadius="0",document.getElementsByClassName("playbtn")[0].style.borderRadius="0");if("web"!=Config.target||SoundManager.canPlayAudio())removeStub(),"android"==Config.target&&(SoundManager=SoundManagerAndroid),"web"==Config.target&&SoundManager.init(),AnimationManager.init(),SequenceChordTypes.init(),
ResourceLoader.loadAll(loadProgress,drawFlush)}function play(){ex.state==ExcerciseStates.answered&&ExcerciseFns.setState(ex,ExcerciseStates.pending);ex.playTask()};
